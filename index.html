<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brettspiel-DB – Meine Sammlung</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --card:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#22d3ee; /* cyan-400 */
      --chip:#1f2937; /* gray-800 */
      --ok:#10b981; /* emerald-500 */
      --warn:#f59e0b; /* amber-500 */
      --err:#ef4444; /* red-500 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1224,#0f172a);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .app{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .brand .logo{width:36px;height:36px;border-radius:10px;background:radial-gradient(circle at 30% 30%,#22d3ee,transparent 40%),radial-gradient(circle at 70% 70%,#10b981,transparent 40%),#0ea5e9;box-shadow:0 0 0 2px #0ea5e944}
    .brand h1{font-size:20px;margin:0}

    .grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg,#0b1224,#0c1222);border:1px solid #1f2937;border-radius:16px;box-shadow:0 8px 30px #0006}
    .card .hd{padding:14px 16px;border-bottom:1px solid #1f2937;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .card .bd{padding:16px}

    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row > *{flex:1}

    input[type="text"], input[type="number"], select{
      width:100%;padding:12px 14px;border-radius:12px;border:1px solid #233047;background:#0b1220;color:var(--text);
    }
    input::placeholder{color:#64748b}

    .btn{padding:10px 14px;border-radius:12px;border:1px solid #1f2937;background:#0b1220;color:var(--text);cursor:pointer}
    .btn:hover{border-color:#334155;background:#0b1428}
    .btn.primary{background:linear-gradient(180deg,#22d3ee,#0ea5e9);border:none;color:#06131a;font-weight:700}
    .btn.ghost{background:transparent;border:1px dashed #334155}

    .results,.library{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:640px){.results,.library{grid-template-columns:1fr}}

    .game{display:flex;gap:12px;padding:12px;border:1px solid #1f2937;background:#0a0f1c;border-radius:14px;min-height:110px}
    .game .cover{width:84px;height:84px;border-radius:10px;background:#0b1224;object-fit:cover;border:1px solid #1f2937}
    .game h3{margin:0 0 4px 0;font-size:15px}
    .meta{display:flex;gap:6px;flex-wrap:wrap}
    .chip{font-size:12px;border:1px solid #26324d;background:var(--chip);padding:3px 8px;border-radius:999px;color:#cbd5e1}

    .empty{color:var(--muted)}

    dialog{border:none;border-radius:16px;padding:0;max-width:720px;width:95vw;background:#0b1220;color:var(--text)}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .modal-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2937}
    .modal-bd{padding:16px}
    .cols{display:grid;grid-template-columns:140px 1fr;gap:16px}
    @media (max-width:700px){.cols{grid-template-columns:1fr}}
    .cover-lg{width:100%;border-radius:12px;border:1px solid #1f2937;object-fit:cover}
    .kvs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kvs div{border:1px solid #1f2937;background:#0a0f1c;border-radius:12px;padding:10px}
    .kvs strong{display:block;font-size:12px;color:#93c5fd;text-transform:uppercase;letter-spacing:.06em}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .right{margin-left:auto}
    .muted{color:#93a0b7}
    .notice{font-size:12px;color:#93a0b7}
    .danger{color:var(--err)}

    .scan{
      border:1px dashed #334155;border-radius:14px;padding:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap
    }
    video{width:240px;max-width:100%;border-radius:10px;border:1px solid #1f2937}
    .tag{background:#0e172c;border:1px solid #26324d;color:#cbd5e1;padding:4px 8px;border-radius:8px;font-size:12px}

    /* Lists modal */
    #lm_lists .list-row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;border:1px solid #1f2937;background:#0a0f1c;border-radius:10px;margin-bottom:8px;cursor:pointer}
    #lm_lists .list-row.active{outline:2px solid #0ea5e9}
    #lm_lists .count{font-size:12px;color:#93a0b7}
  

    /* Collapsible cards */
    .btn.toggle{width:32px;height:32px;padding:0;display:grid;place-items:center;font-weight:700}
    .card.collapsed .bd{display:none}
    .card.collapsed .hd{border-bottom:1px solid transparent}
      .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #2a3857;background:#0b1220;color:var(--text);cursor:pointer}
    .tab[aria-selected="true"]{background:linear-gradient(180deg,#22d3ee,#0ea5e9);color:#06131a;border-color:transparent;font-weight:700}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Brettspiel‑DB</h1>
        <span class="tag">Offline‑Bibliothek (LocalStorage)</span>
      </div>
      <div class="toolbar">
        <input id="proxy" type="text" placeholder="Optional: Proxy‑URL für BGG API (z. B. https://your-proxy.example/)" />
        <select id="listSelect" title="Aktive Liste zum Merken" style="min-width:160px"></select>
        <button class="btn" id="newListBtn" title="Neue Liste anlegen">+ Liste</button>
        <button class="btn" id="viewListsBtn" title="Merklisten öffnen">Listen</button>
        <button class="btn" id="exportBtn">Export</button>
        <button class="btn" id="importBtn">Import</button>
        <input id="importFile" type="file" accept="application/json" hidden>
      </div>
    </header>

    <nav class="tabs" role="tablist" aria-label="Ansichten">
      <button class="tab" id="tabSearch" aria-selected="true">Suche</button>
      <button class="tab" id="tabLibrary" aria-selected="false">Meine Bibliothek</button>
      <button class="tab" id="tabLists" aria-selected="false">Merklisten</button>
    </nav>

    <div class="grid">
      <!-- LINKER BEREICH: Globale Suche (BGG) -->
      <section class="card" id="searchCard">
        <div class="hd">
          <strong>Spiele suchen (BoardGameGeek)</strong>
          <span class="notice">Tipp: Erst suchen, dann der privaten Liste hinzufügen</span>
        </div>
        <div class="bd">
          <div class="row">
            <input id="q" type="text" placeholder="Titel eingeben, z. B. Catan" />
            <button id="searchBtn" class="btn primary">Suchen</button>
          </div>

          <div class="row" id="searchFilterRow" style="margin-top:8px">
            <input id="sPlayers" type="number" min="1" placeholder="Spieler (z. B. 3)" />
            <input id="sTime" type="number" min="1" placeholder="Dauer (≤ Minuten)" />
            <select id="sCategory">
              <option value="">Kategorie: alle</option>
            </select>
            <select id="sSort">
              <option value="relevance">Sortieren: Relevanz</option>
              <option value="rating">Bewertung</option>
              <option value="year">Jahr</option>
              <option value="time">Dauer</option>
              <option value="name">Name</option>
            </select>
            <button class="btn" id="sReset">Filter zurücksetzen</button>
          </div>

          <div id="searchLinks" class="notice" style="margin-top:8px; display:none"></div>
          <div id="results" class="results" style="margin-top:12px"></div>
          <div id="manualSlot" style="margin-top:12px"></div>
          <div id="resultsEmpty" class="empty" style="display:none;margin-top:12px">Keine Treffer.</div>
        </div>
      </section>

      <!-- RECHTER BEREICH: Meine Bibliothek + Filter -->
      <section class="card" id="libraryCard">
        <div class="hd">
          <strong>Meine Bibliothek</strong>
          <div class="toolbar right">
            <select id="sort">
              <option value="name">Sortieren: Name</option>
              <option value="rating">Sortieren: Bewertung</option>
              <option value="time">Sortieren: Dauer</option>
              <option value="year">Sortieren: Jahr</option>
              <option value="players">Sortieren: Spielerzahl</option>
            </select>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="margin-bottom:8px">
            <input id="filterText" type="text" placeholder="In meiner Bibliothek suchen…">
          </div>
          <div class="row">
            <input id="filterPlayers" type="number" min="1" placeholder="Spielerzahl, z. B. 3">
            <input id="filterTime" type="number" min="1" placeholder="Dauer (≤ Minuten), z. B. 30">
            <select id="filterCategory">
              <option value="">Kategorie: alle</option>
            </select>
            <button class="btn" id="resetFilters">Filter zurücksetzen</button>
          </div>
          <div id="library" class="library" style="margin-top:12px"></div>
          <div id="libraryEmpty" class="empty" style="display:none;margin-top:12px">Noch keine Spiele hinzugefügt.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal: Game Details -->
  <dialog id="gameModal">
    <div class="modal-hd">
      <strong id="m_title">Spiel</strong>
      <button class="btn" id="m_close">Schließen</button>
    </div>
    <div class="modal-bd">
      <div class="cols">
        <img id="m_cover" class="cover-lg" alt="Cover" />
        <div>
          <p id="m_desc" class="muted"></p>
          <div class="kvs" style="margin-top:10px">
            <div><strong>Spieler</strong><span id="m_players"></span></div>
            <div><strong>Dauer</strong><span id="m_time"></span></div>
            <div><strong>Bewertung</strong><span id="m_rating"></span></div>
            <div><strong>Jahr</strong><span id="m_year"></span></div>
          </div>
          <div class="meta" id="m_categories" style="margin-top:10px"></div>
          <div class="toolbar" style="margin-top:12px">
            <a id="m_bgg" class="btn" target="_blank" rel="noopener">BGG‑Seite</a>
            <a id="m_rules" class="btn" target="_blank" rel="noopener">Regeln suchen</a>
            <a id="m_howto" class="btn" target="_blank" rel="noopener">YouTube‑Anleitung</a>
          </div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Modal: Manuelle Anlage -->
  <dialog id="manualModal">
    <div class="modal-hd">
      <strong>Eigenen Eintrag anlegen</strong>
      <button class="btn" id="mm_close">Schließen</button>
    </div>
    <div class="modal-bd">
      <div class="row" style="margin-bottom:8px">
        <input id="mm_name" type="text" placeholder="Titel (Pflicht)" />
      </div>
      <div class="row" style="margin-bottom:8px">
        <textarea id="mm_desc" placeholder="Kurzbeschreibung" rows="4" style="width:100%;padding:12px 14px;border-radius:12px;border:1px solid #233047;background:#0b1220;color:var(--text)"></textarea>
      </div>
      <div class="row">
        <input id="mm_pmin" type="number" min="1" placeholder="Min Spieler" />
        <input id="mm_pmax" type="number" min="1" placeholder="Max Spieler" />
        <input id="mm_time" type="number" min="1" placeholder="Dauer (Min)" />
        <input id="mm_year" type="number" min="1800" max="2100" placeholder="Jahr" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="mm_bayes" type="number" step="0.01" placeholder="Bayes‑Bewertung" />
        <input id="mm_avg" type="number" step="0.01" placeholder="Durchschnitt" />
      </div>
      <div class="row" style="margin-top:8px">
        <input id="mm_cats" type="text" placeholder="Kategorien (Komma getrennt)" />
        <input id="mm_mech" type="text" placeholder="Mechaniken (Komma getrennt)" />
      </div>
      <div class="toolbar" style="margin-top:12px">
        <button class="btn" id="mm_toList">Zu aktiver Liste</button>
        <button class="btn" id="mm_toLib">Zur Bibliothek</button>
      </div>
    </div>
  </dialog>

  <!-- Modal: Merklisten -->
  <dialog id="listsModal">
    <div class="modal-hd">
      <strong>Merklisten</strong>
      <button class="btn" id="lm_close">Schließen</button>
    </div>
    <div class="modal-bd">
      <div class="cols" style="grid-template-columns:220px 1fr">
        <div>
          <div class="toolbar" style="margin-bottom:8px">
            <button class="btn" id="lm_new">+ Neue Liste</button>
          </div>
          <div id="lm_lists"></div>
        </div>
        <div>
          <div class="toolbar" style="margin-bottom:8px">
            <strong id="lm_title" style="margin-right:auto">Liste</strong>
            <button class="btn" id="lm_rename">Umbenennen</button>
            <button class="btn" id="lm_delete">Löschen</button>
          </div>
          <div id="lm_items" class="library"></div>
          <div id="lm_empty" class="empty" style="display:none">Keine Einträge.</div>
        </div>
      </div>
    </div>
  </dialog>

  <script>
    // ------------------------------
    // Util & Storage
    // ------------------------------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const STORAGE_KEY = 'bgg_my_library_v1';
    const CACHE_KEY = 'bgg_cache_v1';
    const LISTS_KEY = 'bgg_lists_v1';
    
    const state = {
      library: load(STORAGE_KEY, []),
      cache: load(CACHE_KEY, {}),
      proxy: localStorage.getItem('bgg_proxy') || 'https://board-game-database.l-dxx.workers.dev',
      lists: load(LISTS_KEY, { default: { id:'default', name:'Merkliste', items:[] } }),
      searchItems: []
    };

    function save(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
    function load(k, fallback){ try{ return JSON.parse(localStorage.getItem(k)) ?? fallback } catch{ return fallback } }

    // Persist proxy input
    const proxyInput = $('#proxy');
    proxyInput.value = state.proxy;
    proxyInput.addEventListener('change', () => {
      state.proxy = proxyInput.value.trim();
      localStorage.setItem('bgg_proxy', state.proxy);
    });

    // Lists UI
    const listSelect = $('#listSelect');
    const newListBtn = $('#newListBtn');

    function refreshListSelect(){
      const lists = Object.values(state.lists);
      listSelect.innerHTML = lists.map(l=>`<option value="${l.id}">${escapeHtml(l.name)}</option>`).join('');
    }
    refreshListSelect();

    newListBtn.addEventListener('click',()=>{
      const name = prompt('Name der neuen Liste:','Merkliste');
      if(!name) return;
      const id = 'list_' + Math.random().toString(36).slice(2,8);
      state.lists[id] = {id, name, items:[]};
      save(LISTS_KEY, state.lists);
      refreshListSelect();
      listSelect.value = id;
    });

    // ------------------------------
    // BoardGameGeek API (XML2)
    // Docs: https://boardgamegeek.com/wiki/page/BGG_XML_API2
    // NOTE: Je nach Browser sind CORS-Header auf api.geekdo.com evtl. restriktiv.
    // Falls Requests blockiert werden, trage oben eine Proxy-URL ein (eigener kleiner CORS-Proxy oder dev-Proxy).
    // ------------------------------
    const BGG = {
      base: 'https://api.geekdo.com/xmlapi2',
      async search(query){
        const url = `${this.base}/search?type=boardgame,boardgameexpansion&query=${encodeURIComponent(query)}`;
        const xml = await fetchXML(url);
        const items = [...xml.querySelectorAll('item')].map(x => ({
          id: x.getAttribute('id'),
          name: x.querySelector('name')?.getAttribute('value') || 'Unbenannt',
          year: x.querySelector('yearpublished')?.getAttribute('value') || ''
        }));
        return items;
      },
      async thing(ids){
        // BGG erlaubt große Batches; wir splitten sicherheitshalber
        const out = [];
        const chunk = async (arr) => {
          const url = `${this.base}/thing?id=${arr.join(',')}&stats=1`;
          const xml = await fetchXML(url);
          out.push(...[...xml.querySelectorAll('item')].map(parseThing));
        };
        for (let i=0;i<ids.length;i+=50){
          await chunk(ids.slice(i,i+50));
        }
        return out;
      }
    };

    async function fetchXML(url){
      const final = state.proxy ? (state.proxy.replace(/\/$/, '') + '/' + url) : url;
      const res = await fetch(final);
      if(!res.ok){ throw new Error('HTTP ' + res.status + ' – ' + final); }


    async function fetchJSON(url){
      const final = state.proxy ? (state.proxy.replace(/\/$/, '') + '/' + url) : url;
      const res = await fetch(final);
      if(!res.ok) throw new Error('HTTP ' + res.status + ' – ' + final);
      return await res.json();
    }
      const txt = await res.text();
      return new DOMParser().parseFromString(txt, 'text/xml');
    }

    function parseThing(item){
      const getVal = (sel, attr='value') => item.querySelector(sel)?.getAttribute(attr);
      const name = [...item.querySelectorAll('name')].find(n => n.getAttribute('type')==='primary')?.getAttribute('value') || getVal('name') || 'Unbenannt';
      const id = item.getAttribute('id');
      const image = getVal('image','textContent') || getVal('thumbnail','textContent') || '';
      const desc = (item.querySelector('description')?.textContent || '').replace(/\s+/g,' ').trim();
      const year = getVal('yearpublished') || '';
      const minplayers = +(getVal('minplayers') || 0);
      const maxplayers = +(getVal('maxplayers') || 0);
      const minplaytime = +(getVal('minplaytime') || 0);
      const maxplaytime = +(getVal('maxplaytime') || 0);
      const playingtime = +(getVal('playingtime') || maxplaytime || minplaytime || 0);
      const avg = +(item.querySelector('ratings average')?.getAttribute('value') || 0);
      const bayes = +(item.querySelector('ratings bayesaverage')?.getAttribute('value') || 0);
      const ranks = [...item.querySelectorAll('ranks rank')].map(r => ({name:r.getAttribute('name'), value:+(r.getAttribute('value')||0)}));
      const categories = [...item.querySelectorAll('link[type="boardgamecategory"]')].map(l => l.getAttribute('value'));
      const mechanics = [...item.querySelectorAll('link[type="boardgamemechanic"]')].map(l => l.getAttribute('value'));
      return {
        id, name, year: year ? +year : '',
        image, desc,
        players:{min:minplayers, max:maxplayers},
        playtime:{min:minplaytime, max:maxplaytime, typical:playingtime},
        rating:{avg, bayes, ranks},
        categories, mechanics
      };
    }

    // ------------------------------
    // UI: Suche (links)
    // ------------------------------
    const resultsEl = $('#results');
    const resultsEmpty = $('#resultsEmpty');
    $('#searchBtn').addEventListener('click', doSearch);
    $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch() });

    // Search filters UI (inputs live in the Search card header area)
    const sPlayers = document.getElementById('sPlayers');
    const sTime = document.getElementById('sTime');
    const sCategory = document.getElementById('sCategory');
    const sSort = document.getElementById('sSort');
    const sReset = document.getElementById('sReset');
    ;[sPlayers, sTime, sCategory, sSort].forEach(el => el && el.addEventListener('input', applySearchFiltersAndRender));
    if(sReset) sReset.addEventListener('click', ()=>{ if(sPlayers) sPlayers.value=''; if(sTime) sTime.value=''; if(sCategory) sCategory.value=''; if(sSort) sSort.value='relevance'; applySearchFiltersAndRender(); });
        // External links for broader search (BGG geeksearch)
        const sl = document.getElementById('searchLinks');
        if(sl){
          const qEnc = encodeURIComponent(q);
          sl.innerHTML = `Weitere Treffer: <a href="https://boardgamegeek.com/geeksearch.php?action=search&objecttype=boardgame&q=${qEnc}" target="_blank" rel="noopener">BGG-Suche öffnen</a>`;
          sl.style.display = 'block';
        } });

    async function doSearch(){
      const q = $('#q').value.trim();
      if(!q){ resultsEl.innerHTML=''; resultsEmpty.style.display='block'; return }
      setLoading(resultsEl);
      resultsEmpty.style.display='none';
      try{
        const hits = await BGG.search(q);
        if(hits.length===0){ resultsEl.innerHTML=''; resultsEmpty.style.display='block'; return }
        const ids = hits.slice(0,100).map(h=>h.id);
        const things = await BGG.thing(ids);
        state.searchItems = things;
        // Update external search link (BGG geeksearch)
        const sl = document.getElementById('searchLinks');
        if(sl){
          const qEnc = encodeURIComponent(q);
          sl.innerHTML = `Weitere Treffer: <a href="https://boardgamegeek.com/geeksearch.php?action=search&objecttype=boardgame&q=${qEnc}" target="_blank" rel="noopener">BGG‑Suche öffnen</a>`;
          sl.style.display = 'block';
        }
        applySearchFiltersAndRender();
      }catch(err){
        resultsEl.innerHTML = `<div class="empty">Fehler bei der Suche: <span class="danger">${escapeHtml(err.message)}</span><br><span class="notice">Tipp: Falls CORS-Fehler auftreten, trage oben eine Proxy‑URL ein.</span></div>`
      }
    }

    function applySearchFiltersAndRender(){
      let items = state.searchItems.slice();
      const players = sPlayers ? (+sPlayers.value || null) : null;
      const tmax = sTime ? (+sTime.value || null) : null;
      const cat = sCategory ? (sCategory.value || '') : '';

      if(players) items = items.filter(g => g.players.min <= players && g.players.max >= players);
      if(tmax) items = items.filter(g => (g.playtime.typical||g.playtime.max||g.playtime.min) <= tmax);
      if(cat) items = items.filter(g => g.categories.includes(cat));

      const sortBy = sSort ? sSort.value : 'relevance';
      if(sortBy==='rating') items.sort((a,b)=>(b.rating.bayes||b.rating.avg)-(a.rating.bayes||a.rating.avg));
      else if(sortBy==='year') items.sort((a,b)=>(b.year||0)-(a.year||0));
      else if(sortBy==='time') items.sort((a,b)=>(a.playtime.typical||a.playtime.max||a.playtime.min)-(b.playtime.typical||b.playtime.max||b.playtime.min));
      else if(sortBy==='name') items.sort((a,b)=>a.name.localeCompare(b.name));

      renderResults(items);
    }
      setLoading(resultsEl);
      resultsEmpty.style.display='none';
      try{
        const hits = await BGG.search(q);
        if(hits.length===0){ resultsEl.innerHTML=''; resultsEmpty.style.display='block'; return }
        // Fetch details (batched) for richer cards
        const ids = hits.slice(0,24).map(h=>h.id);
        const things = await BGG.thing(ids);
        renderResults(things);
      }catch(err){
        resultsEl.innerHTML = `<div class="empty">Fehler bei der Suche: <span class="danger">${escapeHtml(err.message)}</span><br><span class="notice">Tipp: Falls CORS-Fehler auftreten, trage oben eine Proxy‑URL ein.</span></div>`
      }
    }

    function renderResults(items){
      resultsEl.innerHTML = '';
      // Build category filter options from current search set
      const cats = new Set();
      items.forEach(g => g.categories.forEach(c=>cats.add(c)));
      $('#sCategory').innerHTML = ['<option value="">Kategorie: alle</option>', ...[...cats].sort().map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`)].join('');

      const limited = items.slice(0,7);
      limited.forEach(game => {
        const card = renderSearchCard(game);
        resultsEl.appendChild(card);
      });

      renderManualCreateCard();
    }

    function renderManualCreateCard(){
      const slot = document.getElementById('manualSlot');
      slot.innerHTML = '';
      const el = document.createElement('div');
      el.className = 'game';
      el.innerHTML = `
        <div style="width:84px;height:84px;border:1px dashed #334155;border-radius:10px;display:grid;place-items:center">＋</div>
        <div style="flex:1">
          <h3>Manuell anlegen</h3>
          <p class="muted">Eigene Daten eintragen: Beschreibung, Spielerzahl, Dauer, Jahr, Bewertung, Kategorien & Mechaniken.</p>
          <div class="toolbar" style="margin-top:8px">
            <button class="btn" id="btnManualAddToList">Zu aktiver Liste</button>
            <button class="btn" id="btnManualAddToLib">Zur Bibliothek</button>
          </div>
        </div>`;
      slot.appendChild(el);
      el.querySelector('#btnManualAddToList').addEventListener('click', ()=> openManualModal('list'));
      el.querySelector('#btnManualAddToLib').addEventListener('click', ()=> openManualModal('library'));
    }">${escapeHtml(c)}</option>`)].join('');

      items.forEach(game => {
        const card = renderSearchCard(game);
        resultsEl.appendChild(card);
      });
    }

    function renderSearchCard(game){
      const el = document.createElement('div');
      el.className = 'game';
      el.innerHTML = `
        <img class="cover" alt="Cover" src="${escapeHtml(game.image || '')}" onerror="this.style.display='none'"/>
        <div style="flex:1">
          <h3>${escapeHtml(game.name)}</h3>
          <div class="meta">
            ${game.year ? `<span class="chip">${game.year}</span>` : ''}
            <span class="chip">${game.players.min||'?'}–${game.players.max||'?'} Spieler</span>
            <span class="chip">${game.playtime.typical || game.playtime.max || game.playtime.min || '?'} Min</span>
            ${Number.isFinite(game.rating.bayes) && game.rating.bayes>0 ? `<span class="chip">⭐ ${game.rating.bayes.toFixed(2)}</span>` : ''}
          </div>
          <p class="muted">${escapeHtml((game.desc||'').slice(0,220))}${(game.desc||'').length>220?'…':''}</p>
          <div class="toolbar" style="margin-top:8px">
            <a class="btn" href="https://boardgamegeek.com/boardgame/${encodeURIComponent(game.id)}" target="_blank" rel="noopener">BGG‑Seite</a>
            <button class="btn" data-action="remember">Merken</button>
            <button class="btn" data-action="addlib">Zur Bibliothek</button>
          </div>
        </div>`;

      // Actions
      el.querySelector('[data-action="remember"]').addEventListener('click', (e)=>{
        e.stopPropagation();
        const listId = listSelect.value || 'default';
        ensureList(listId);
        addToList(listId, game.id);
      });
      el.querySelector('[data-action="addlib"]').addEventListener('click', (e)=>{ e.stopPropagation(); if(!inLibrary(game.id)) addToLibrary(game); });

      // Open modal when clicking card (if already in library)
      el.addEventListener('click', (ev)=>{ if(ev.target.closest('button,a')) return; if(inLibrary(game.id)) openModal(game.id); });

      return el;
    }
          ]
        });
        resultsEl.appendChild(card);
      });
    }

    function toggleAdd(game){
      if(inLibrary(game.id)) return;
      addToLibrary(game);
    }

    // Lists helpers
    function ensureList(id){ if(!state.lists[id]){ state.lists[id] = {id, name:'Liste', items:[]}; save(LISTS_KEY, state.lists); refreshListSelect(); } }
    function addToList(id, gameId){
      const list = state.lists[id];
      if(!list.items.includes(gameId)) list.items.push(gameId);
      save(LISTS_KEY, state.lists);
      // kleines Feedback
      const name = state.lists[id].name || 'Liste';
      toast(`Zu "${escapeHtml(name)}" gemerkt.`);
    }

    // ------------------------------
    // Library & Filter (rechts)
    // ------------------------------
    const libEl = $('#library');
    const libEmpty = $('#libraryEmpty');
    const filterText = $('#filterText');
    const filterPlayers = $('#filterPlayers');
    const filterTime = $('#filterTime');
    const filterCategory = $('#filterCategory');
    const sortSel = $('#sort');
    const resetBtn = $('#resetFilters');

    [filterText, filterPlayers, filterTime, filterCategory, sortSel].forEach(el => el.addEventListener('input', renderLibrary));
    resetBtn.addEventListener('click', ()=>{
      filterText.value=''; filterPlayers.value=''; filterTime.value=''; filterCategory.value=''; sortSel.value='name'; renderLibrary();
    });

    function inLibrary(id){ return state.library.some(g=>g.id===id) }

    function addToLibrary(game){
      // Keep cache
      state.cache[game.id] = game;
      save(CACHE_KEY, state.cache);
      state.library.push(game);
      save(STORAGE_KEY, state.library);
      renderLibrary();
    }

    function removeFromLibrary(id){
      state.library = state.library.filter(g=>g.id!==id);
      save(STORAGE_KEY, state.library);
      renderLibrary();
    }

    function renderLibrary(){
      // Build category filter options
      const cats = new Set();
      state.library.forEach(g => g.categories.forEach(c => cats.add(c)));
      const catOpts = ['<option value="">Kategorie: alle</option>', ...[...cats].sort().map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`)];
      filterCategory.innerHTML = catOpts.join('');

      const q = filterText.value.trim().toLowerCase();
      const players = +filterPlayers.value || null;
      const tmax = +filterTime.value || null;
      const cat = filterCategory.value || '';

      let items = state.library.slice();
      if(q) items = items.filter(g => g.name.toLowerCase().includes(q));
      if(players) items = items.filter(g => g.players.min <= players && g.players.max >= players);
      if(tmax) items = items.filter(g => (g.playtime.typical || g.playtime.max || g.playtime.min) <= tmax);
      if(cat) items = items.filter(g => g.categories.includes(cat));

      const sortBy = sortSel.value;
      items.sort((a,b)=>{
        switch(sortBy){
          case 'rating': return (b.rating.bayes||b.rating.avg) - (a.rating.bayes||a.rating.avg);
          case 'time': return (a.playtime.typical||a.playtime.max||a.playtime.min) - (b.playtime.typical||b.playtime.max||b.playtime.min);
          case 'year': return (b.year||0) - (a.year||0);
          case 'players': return (b.players.max||0) - (a.players.max||0);
          default: return a.name.localeCompare(b.name);
        }
      });

      libEl.innerHTML = '';
      if(items.length===0){ libEmpty.style.display='block'; return } else { libEmpty.style.display='none' }

      items.forEach(game => {
        const card = renderGameCard(game, {
          actions: [
            { label: 'Details', onClick: () => openModal(game.id) },
            { label: 'Entfernen', onClick: () => removeFromLibrary(game.id) }
          ]
        });
        libEl.appendChild(card);
      });
    }

    function renderGameCard(game, {actions=[]}={}){
      const el = document.createElement('div');
      el.className = 'game';
      el.innerHTML = `
        <img class="cover" alt="Cover" src="${escapeHtml(game.image || '')}" onerror="this.style.display='none'"/>
        <div style="flex:1">
          <h3>${escapeHtml(game.name)}</h3>
          <div class="meta">
            <span class="chip">${game.players.min||'?'}–${game.players.max||'?'} Spieler</span>
            <span class="chip">${game.playtime.typical || game.playtime.max || game.playtime.min || '?'} Min</span>
            ${game.year ? `<span class="chip">${game.year}</span>` : ''}
            ${Number.isFinite(game.rating.bayes) && game.rating.bayes>0 ? `<span class="chip">⭐ ${game.rating.bayes.toFixed(2)}</span>` : ''}
          </div>
          <div class="toolbar" style="margin-top:8px"></div>
        </div>`;
      const bar = $('.toolbar', el);
      actions.forEach(a => {
        const b = document.createElement('button');
        b.className = 'btn';
        b.textContent = a.label;
        b.addEventListener('click', a.onClick);
        bar.appendChild(b);
      });
      // Clicking the card opens details (if in library)
      el.addEventListener('click', (ev)=>{
        if(ev.target.closest('button')) return;
        if(inLibrary(game.id)) openModal(game.id);
      });
      return el;
    }

    // ------------------------------
    // Modal: Game Details
    // ------------------------------
    const modal = $('#gameModal');
    $('#m_close').addEventListener('click', ()=> modal.close());

    async function openModal(id){
      // Ensure we have fresh details in cache
      let game = state.cache[id];
      if(!game){
        const [thing] = await BGG.thing([id]);
        game = thing; state.cache[id]=game; save(CACHE_KEY, state.cache);
      }
      $('#m_title').textContent = game.name;
      $('#m_cover').src = game.image || '';
      $('#m_desc').textContent = game.desc || '—';
      $('#m_players').textContent = `${game.players.min||'?'}–${game.players.max||'?'} Spieler`;
      const tm = game.playtime;
      $('#m_time').textContent = `${tm.typical||tm.max||tm.min||'?'} Min`;
      $('#m_rating').textContent = (game.rating.bayes>0 ? game.rating.bayes.toFixed(2) : game.rating.avg>0 ? game.rating.avg.toFixed(2) : '—');
      $('#m_year').textContent = game.year || '—';
      const catEl = $('#m_categories'); catEl.innerHTML='';
      game.categories.slice(0,10).forEach(c => { const s=document.createElement('span'); s.className='chip'; s.textContent=c; catEl.appendChild(s); });
      $('#m_bgg').href = `https://boardgamegeek.com/boardgame/${encodeURIComponent(game.id)}`;
      const q = encodeURIComponent(`${game.name} board game rules pdf`);
      $('#m_rules').href = `https://www.google.com/search?q=${q}`;
      const yt = encodeURIComponent(`${game.name} how to play`);
      $('#m_howto').href = `https://www.youtube.com/results?search_query=${yt}`;
      modal.showModal();
    }

    // ------------------------------
    // Export / Import
    // ------------------------------
    $('#exportBtn').addEventListener('click', ()=>{
      const data = { library: state.library, cache: state.cache, exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'brettspiel-db-export.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    });

    $('#importBtn').addEventListener('click', ()=> $('#importFile').click());
    $('#importFile').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      try{
        const txt = await file.text();
        const data = JSON.parse(txt);
        if(Array.isArray(data.library)) state.library = data.library; else throw new Error('Ungültiges Format (library)');
        if(data.cache && typeof data.cache === 'object') state.cache = data.cache; else state.cache={};
        save(STORAGE_KEY, state.library); save(CACHE_KEY, state.cache);
        renderLibrary();
      }catch(err){ alert('Import fehlgeschlagen: '+err.message) }
      e.target.value = '';
    });
    // ------------------------------
    // Helpers
    // ------------------------------
    function setLoading(el){ el.innerHTML = '<div class="empty">Lade …</div>'; }
    function escapeHtml(s){ return String(s).replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) }

    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg; t.style.cssText = 'position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0b1220;border:1px solid #334155;border-radius:12px;padding:10px 14px;box-shadow:0 10px 30px #0006;z-index:9999';
      document.body.appendChild(t);
      setTimeout(()=>{ t.remove(); }, 1600);
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) }(s){ return String(s).replace(/[&<>"]+/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) }

    // ------------------------------
    // Collapsible Cards (Search & Library)
    // ------------------------------
    const UI_COLLAPSE_KEY = 'ui_collapse_v1';

    function makeCollapsible(card, key, defaultOpen=true){
      const saved = load(UI_COLLAPSE_KEY, {});
      const startCollapsed = saved[key] ?? !defaultOpen;
      if(startCollapsed) card.classList.add('collapsed');

      const btn = document.createElement('button');
      btn.className = 'btn toggle';
      const setIcon = () => { btn.textContent = card.classList.contains('collapsed') ? '▸' : '▾'; btn.title = card.classList.contains('collapsed') ? 'Aufklappen' : 'Zuklappen'; };
      setIcon();
      btn.addEventListener('click', (e)=>{
        e.preventDefault(); e.stopPropagation();
        card.classList.toggle('collapsed');
        const s = load(UI_COLLAPSE_KEY, {});
        s[key] = card.classList.contains('collapsed');
        save(UI_COLLAPSE_KEY, s);
        setIcon();
      });
      const hd = card.querySelector('.hd');
      hd.appendChild(btn);
    }

    const cards = document.querySelectorAll('.grid > section.card');
    if(cards[0]) makeCollapsible(cards[0], 'search', true);
    if(cards[1]) makeCollapsible(cards[1], 'library', true);

    // Initial render
    renderLibrary();

    // ------------------------------
    // Tabs (Menu) – Suche / Bibliothek / Listen
    // ------------------------------
    const tabSearch = document.getElementById('tabSearch');
    const tabLibrary = document.getElementById('tabLibrary');
    const tabLists = document.getElementById('tabLists');
    const searchCard = document.getElementById('searchCard');
    const libraryCard = document.getElementById('libraryCard');
    const grid = document.querySelector('.grid');

    function setView(view){
      const setSel = (btn, sel) => btn.setAttribute('aria-selected', sel ? 'true' : 'false');
      searchCard.style.display = (view==='search') ? '' : 'none';
      libraryCard.style.display = (view==='library') ? '' : 'none';
      setSel(tabSearch, view==='search');
      setSel(tabLibrary, view==='library');
      setSel(tabLists, view==='lists');
      grid.style.gridTemplateColumns = '1fr';
      if(view==='lists'){ openListsModal(listSelect.value || 'default'); }
    }
    }

    tabSearch.addEventListener('click', ()=> setView('search'));
    tabLibrary.addEventListener('click', ()=> setView('library'));
    tabLists.addEventListener('click', ()=> setView('lists'));
    // Startansicht: Suche
    setView('search');

    // ------------------------------
    // Merklisten-Modal (browse & manage)
    // ------------------------------
    const listsModal = document.getElementById('listsModal');
    const lmClose = document.getElementById('lm_close');
    const lmLists = document.getElementById('lm_lists');
    const lmItems = document.getElementById('lm_items');
    const lmEmpty = document.getElementById('lm_empty');
    const lmTitle = document.getElementById('lm_title');
    const lmNew = document.getElementById('lm_new');
    const lmRename = document.getElementById('lm_rename');
    const lmDelete = document.getElementById('lm_delete');

    document.getElementById('viewListsBtn').addEventListener('click', () => openListsModal(listSelect.value || 'default'));
    lmClose.addEventListener('click', ()=> listsModal.close());
    lmNew.addEventListener('click', ()=> newListBtn.click());

    let lmActive = null;

    function openListsModal(listId){
      ensureList(listId);
      lmActive = listId;
      renderListsSidebar();
      renderListItems(listId);
      listsModal.showModal();
    }

    function renderListsSidebar(){
      const entries = Object.values(state.lists);
      lmLists.innerHTML = entries.map(l => `
        <div class="list-row ${l.id===lmActive?'active':''}" data-id="${l.id}">
          <span>${escapeHtml(l.name)}</span>
          <span class="count">${l.items.length}</span>
        </div>
      `).join('');
      lmLists.querySelectorAll('.list-row').forEach(row => {
        row.addEventListener('click', ()=>{ lmActive = row.getAttribute('data-id'); renderListsSidebar(); renderListItems(lmActive); });
      });
    }

    lmRename.addEventListener('click', ()=>{
      if(!lmActive) return; const name = prompt('Neuer Listenname:', state.lists[lmActive]?.name || 'Liste');
      if(!name) return; state.lists[lmActive].name = name; save(LISTS_KEY, state.lists); renderListsSidebar(); renderListItems(lmActive);
    });
    lmDelete.addEventListener('click', ()=>{
      if(!lmActive) return; if(!confirm('Liste wirklich löschen?')) return;
      delete state.lists[lmActive]; save(LISTS_KEY, state.lists);
      const first = Object.keys(state.lists)[0] || null; lmActive = first; renderListsSidebar(); if(first) renderListItems(first); else { lmItems.innerHTML=''; lmEmpty.style.display='block'; lmTitle.textContent='Liste'; }
    });

    async function renderListItems(listId){
      const list = state.lists[listId];
      if(!list){ lmItems.innerHTML=''; lmEmpty.style.display='block'; lmTitle.textContent='Liste'; return; }
      lmTitle.textContent = list.name;
      lmItems.innerHTML = '';
      lmEmpty.style.display = list.items.length ? 'none' : 'block';

      for(const id of list.items){
        const game = await getOrFetchGame(id);
        const card = renderGameCard(game, {
          actions: [
            { label: 'Details', onClick: () => inLibrary(game.id) ? openModal(game.id) : null },
            { label: inLibrary(game.id) ? 'Schon in Bibliothek' : 'Zur Bibliothek', onClick: () => { if(!inLibrary(game.id)) addToLibrary(game); } },
            { label: 'Aus Liste entfernen', onClick: () => { removeFromList(listId, id); renderListItems(listId); } }
          ]
        });
        lmItems.appendChild(card);
      }
    }

    function removeFromList(listId, gameId){
      const list = state.lists[listId];
      list.items = list.items.filter(id => id !== gameId);
      save(LISTS_KEY, state.lists);
      toast('Aus Liste entfernt.');
    }

    async function getOrFetchGame(id){
      if(state.cache[id]) return state.cache[id];
      if(/^custom-/.test(id)) return state.cache[id] || null; // custom wird nur aus cache gelesen
      try{
        const [thing] = await BGG.thing([id]);
        state.cache[id] = thing; save(CACHE_KEY, state.cache);
        return thing;
      }catch{ return { id, name: 'Unbekannt', players:{min:0,max:0}, playtime:{min:0,max:0,typical:0}, rating:{avg:0,bayes:0,ranks:[]}, categories:[], mechanics:[], desc:'—', year:'' } }
    }

    // ------------------------------
    // Manuelle Anlage – Logik
    // ------------------------------
    const manualModal = document.getElementById('manualModal');
    const mmClose = document.getElementById('mm_close');
    const mmToList = document.getElementById('mm_toList');
    const mmToLib = document.getElementById('mm_toLib');

    let manualTarget = 'list';

    function openManualModal(target='list'){
      manualTarget = target;
      manualModal.showModal();
    }

    mmClose.addEventListener('click', ()=> manualModal.close());

    function readManualForm(){
      const name = document.getElementById('mm_name').value.trim();
      if(!name){ alert('Bitte einen Titel eingeben.'); return null; }
      const desc = document.getElementById('mm_desc').value.trim();
      const pmin = parseInt(document.getElementById('mm_pmin').value)||0;
      const pmax = parseInt(document.getElementById('mm_pmax').value)||0;
      const time = parseInt(document.getElementById('mm_time').value)||0;
      const year = parseInt(document.getElementById('mm_year').value)||'';
      const bayes = parseFloat(document.getElementById('mm_bayes').value)||0;
      const avg = parseFloat(document.getElementById('mm_avg').value)||0;
      const cats = (document.getElementById('mm_cats').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      const mech = (document.getElementById('mm_mech').value||'').split(',').map(s=>s.trim()).filter(Boolean);
      const id = 'custom-' + Date.now();
      const game = { id, name, year, image:'', desc, players:{min:pmin,max:pmax}, playtime:{min:0,max:0,typical:time}, rating:{avg,bayes,ranks:[]}, categories:cats, mechanics:mech };
      return game;
    }

    function clearManualForm(){
      ['mm_name','mm_desc','mm_pmin','mm_pmax','mm_time','mm_year','mm_bayes','mm_avg','mm_cats','mm_mech'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    }

    mmToList.addEventListener('click', ()=>{
      const game = readManualForm(); if(!game) return;
      state.cache[game.id]=game; save(CACHE_KEY, state.cache);
      const listId = listSelect.value || 'default'; ensureList(listId); addToList(listId, game.id);
      manualModal.close(); clearManualForm();
    });

    mmToLib.addEventListener('click', ()=>{
      const game = readManualForm(); if(!game) return;
      state.cache[game.id]=game; save(CACHE_KEY, state.cache);
      addToLibrary(game);
      manualModal.close(); clearManualForm();
    });
